<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wander Connect</title>
<style>
  body{font-family:monospace;background:#000;color:#0f0;margin:0;padding:20px}
  h1{text-align:center;text-shadow:0 0 10px #00FF00}
  .ribbon{background:#111;padding:12px;border-radius:6px;text-align:center;margin-bottom:10px}
  button{background:none;border:2px solid #00FF00;color:#00FF00;padding:10px 18px;border-radius:6px;cursor:pointer;margin:5px}
  button:hover{background:#00FF00;color:#000}
  button:disabled{opacity:0.5;cursor:not-allowed}
  #terminal{background:#060606;border:1px solid #003300;color:#A6FFA6;padding:10px;height:400px;overflow:auto;white-space:pre-wrap;margin-top:10px;border-radius:6px}
  .method-section{background:#111;padding:15px;border-radius:6px;margin-bottom:10px;border:1px solid #003300}
  .method-title{color:#00FF00;font-weight:bold;font-size:16px;margin-bottom:10px}
</style>
<script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
</head>
<body>
  <h1>Wander Connect</h1>
  
  <div class="method-section">
    <div class="method-title">MÃ‰TODO 1: ConexiÃ³n Directa con Wander Extension</div>
    <button id="connectBtn">Connect to Wander</button>
  </div>

  <div class="method-section">
    <div class="method-title">MÃ‰TODO 2: Native Wallet (Firma Local)</div>
    <button id="connectNativeBtn">Connect to Native Wallet</button>
  </div>

  <div id="terminal">[INFO] Terminal iniciadoâ€¦</div>

<script>
const term = document.getElementById('terminal');
function log(msg, type='info') {
  const ts = new Date().toISOString();
  const color = type==='err' ? '#FF5555' : type==='event' ? '#55FFFF' : '#A6FFA6';
  term.innerHTML += `\n<span style="color:${color}">${ts} [${type.toUpperCase()}] ${msg}</span>`;
  term.scrollTop = term.scrollHeight;
}

// Detect wallets
if (window.arweaveWallet) {
  log('âœ… Wander wallet detectada', 'info');
}

// Esperar a que NativeWallet estÃ© listo
window.addEventListener('nativeWalletReady', () => {
  log('âœ… Native Wallet extension detectada', 'info');
});

// Verificar si ya existe
if (window.NativeWallet) {
  log('âœ… Native Wallet extension detectada', 'info');
}

// ============================================
// MÃ‰TODO 1: ConexiÃ³n directa con Wander
// ============================================
document.getElementById('connectBtn').addEventListener('click', async () => {
  try {
    if (!window.arweaveWallet) {
      log('âŒ Wander wallet no detectada', 'err');
      return;
    }
    log('Solicitando conexiÃ³n a Wander...', 'event');
    const perms = ["ACCESS_ADDRESS", "SIGN_TRANSACTION"];
    const res = await window.arweaveWallet.connect(perms);
    log('Respuesta connect() => ' + JSON.stringify(res, null, 2), 'info');
    const addr = await window.arweaveWallet.getActiveAddress();
    log('DirecciÃ³n activa => ' + addr, 'info');
    log('âœ… AUTENTICACIÃ“N EXITOSA (Wander)', 'event');
  } catch (e) {
    log('Error durante conexiÃ³n => ' + e.message, 'err');
    console.error(e);
  }
});

// ============================================
// MÃ‰TODO 2: Native Wallet
// ============================================
const connectNativeBtn = document.getElementById('connectNativeBtn');

connectNativeBtn.addEventListener('click', async () => {
  try {
    if (!window.NativeWallet) {
      log('âŒ Native Wallet extension no detectada', 'err');
      log('Instala la extensiÃ³n NativeWallet primero', 'err');
      return;
    }

    log('ðŸ”„ Generando datos de autenticaciÃ³n...', 'event');
    connectNativeBtn.disabled = true;
    
    // Generar mensaje de autenticaciÃ³n
    const timestamp = Date.now();
    const authMessage = {
      app: 'WanderConnect',
      action: 'authenticate',
      timestamp: timestamp,
      message: 'Firma este mensaje para autenticarte en WanderConnect'
    };

    log('ðŸ“¤ Enviando solicitud a Native Wallet...', 'event');
    log('Esperando firma del usuario...', 'info');

    // Conectar con Native Wallet y enviar datos para firmar
    const result = await window.NativeWallet.sign(authMessage);
    
    if (!result.success) {
      log('âŒ Error: ' + (result.error || 'No se pudo firmar'), 'err');
      connectNativeBtn.disabled = false;
      return;
    }

    log('âœ… Firma recibida correctamente', 'info');
    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
    log('DirecciÃ³n autenticada: ' + result.address, 'event');
    log('Transaction ID: ' + result.id, 'info');
    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
    log('âœ… AUTENTICACIÃ“N EXITOSA (Native Wallet)', 'event');
    log('El usuario ha sido autenticado correctamente', 'info');

    connectNativeBtn.disabled = false;

  } catch (e) {
    log('Error durante conexiÃ³n Native => ' + e.message, 'err');
    console.error(e);
    connectNativeBtn.disabled = false;
  }
});

// Escucha mensajes del wallet
window.addEventListener("message", ev => {
  if (typeof ev.data === "object" && ev.data.type && ev.data.type.includes('arweave')) {
    const data = JSON.stringify(ev.data, null, 2);
    log("Mensaje capturado => " + data, "event");
  }
});
</script>
</body>
</html>
