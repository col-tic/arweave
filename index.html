<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auth Debug - Wander / JSON firmado (SECURE)</title>
</head>
<body>
  <h2>üß© Autenticaci√≥n Debug (Modo Seguro)</h2>
  <h3>M√©todo 1: Conectar con Wander</h3>
  <button id="connectBtn">Conectar con Wander</button>
  <h3>M√©todo 2: Archivo firmado manualmente</h3>
  <button id="generateBtn">Generar firmar.json</button>
  <input type="file" id="fileInput" accept=".json" />
  <pre id="output"></pre>
  <script>
    // Estado de sesi√≥n
    let sessionNonce = null;
    let sessionTimestamp = null;
    
    const out = (msg, data) => {
      const pre = document.getElementById("output");
      const timestamp = new Date().toISOString();
      pre.textContent += `\n[${timestamp}] ${msg}` + (data ? "\n" + JSON.stringify(data, null, 2) : "");
    };
    
    const connectBtn = document.getElementById("connectBtn");
    const generateBtn = document.getElementById("generateBtn");
    const fileInput = document.getElementById("fileInput");
    
    // === M√âTODO 1: Conectar con Wander ===
    connectBtn.onclick = async () => {
      out("üîç DEBUG: Verificando extensi√≥n Wander...");
      if (!window.arweaveWallet) {
        out("‚ùå SEGURIDAD: Extensi√≥n Wander no detectada");
        alert("Instala la extensi√≥n Wander primero.");
        return;
      }
      try {
        out("üîê DEBUG: Solicitando permisos...");
        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "SIGN_TRANSACTION"]);
        const address = await window.arweaveWallet.getActiveAddress();
        out("‚úÖ SEGURIDAD: Conexi√≥n autenticada", { address });
      } catch (e) {
        out("‚ùå ERROR:", { error: e.message, stack: e.stack });
      }
    };
    
    // === M√âTODO 2: Autenticaci√≥n manual ===
    generateBtn.onclick = () => {
      out("üîê DEBUG: Generando nonce de sesi√≥n...");
      
      // Generar nonce criptogr√°ficamente seguro
      const nonceArray = new Uint8Array(32);
      crypto.getRandomValues(nonceArray);
      sessionNonce = Array.from(nonceArray, b => b.toString(16).padStart(2, '0')).join('');
      sessionTimestamp = Date.now();
      
      out("‚úÖ SEGURIDAD: Nonce generado", { 
        nonce: sessionNonce.substring(0, 16) + "...",
        timestamp: sessionTimestamp 
      });
      
      const payload = `login-request-${sessionTimestamp}-${sessionNonce}`;
      
      const tx = {
        format: 2,
        owner: "",
        target: "",
        quantity: "0",
        data: btoa(payload),
        reward: "0",
        last_tx: "",
        tags: [
          { name: "App-Name", value: "ManualLogin" },
          { name: "Content-Type", value: "text/plain" },
          { name: "Nonce", value: sessionNonce },
          { name: "Timestamp", value: sessionTimestamp.toString() }
        ],
      };
      
      out("üìã DEBUG: Estructura de transacci√≥n", {
        dataDecoded: payload,
        tagsCount: tx.tags.length
      });
      
      const blob = new Blob([JSON.stringify(tx, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.click();
      out("üìÑ Archivo generado: firmar.json");
    };
    
    // Cargar archivo firmado con validaciones de seguridad
    fileInput.onchange = async (e) => {
      out("\nüîç DEBUG: Procesando archivo subido...");
      const file = e.target.files[0];
      if (!file) return;
      
      // Validaci√≥n 1: Tama√±o de archivo
      out(`üìä DEBUG: Tama√±o del archivo: ${file.size} bytes`);
      if (file.size > 1024 * 1024) { // 1MB max
        out("‚ùå SEGURIDAD: Archivo demasiado grande (max 1MB)");
        return;
      }
      
      // Validaci√≥n 2: Tipo de archivo
      if (file.type && file.type !== "application/json") {
        out("‚ö†Ô∏è ADVERTENCIA: Tipo MIME inesperado", { type: file.type });
      }
      
      const text = await file.text();
      
      try {
        out("üîç DEBUG: Parseando JSON...");
        const tx = JSON.parse(text);
        
        // Validaci√≥n 3: Estructura b√°sica
        out("üîç DEBUG: Validando estructura...");
        const requiredFields = ['format', 'owner', 'data', 'tags', 'signature', 'id'];
        const missingFields = requiredFields.filter(f => !(f in tx));
        
        if (missingFields.length > 0) {
          out("‚ùå SEGURIDAD: Campos faltantes", { missing: missingFields });
          return;
        }
        
        out("‚úÖ DEBUG: Estructura b√°sica v√°lida");
        
        // Validaci√≥n 4: Formato de transacci√≥n
        if (tx.format !== 2) {
          out("‚ùå SEGURIDAD: Formato de transacci√≥n inv√°lido", { format: tx.format });
          return;
        }
        
        // Validaci√≥n 5: Verificar nonce de sesi√≥n
        const txNonce = tx.tags?.find(t => t.name === "Nonce")?.value;
        const txTimestamp = tx.tags?.find(t => t.name === "Timestamp")?.value;
        
        out("üîç DEBUG: Verificando nonce...", { 
          sessionNonce: sessionNonce?.substring(0, 16) + "...",
          txNonce: txNonce?.substring(0, 16) + "..." 
        });
        
        if (!sessionNonce) {
          out("‚ö†Ô∏è ADVERTENCIA: No hay sesi√≥n activa - genera firmar.json primero");
        } else if (txNonce !== sessionNonce) {
          out("‚ùå SEGURIDAD: Nonce no coincide - posible replay attack", {
            expected: sessionNonce.substring(0, 16) + "...",
            received: txNonce?.substring(0, 16) + "..."
          });
          return;
        } else {
          out("‚úÖ SEGURIDAD: Nonce verificado correctamente");
        }
        
        // Validaci√≥n 6: Verificar timestamp (no m√°s de 10 minutos)
        if (sessionTimestamp && txTimestamp) {
          const age = Date.now() - parseInt(txTimestamp);
          const ageMinutes = Math.floor(age / 60000);
          out(`üïê DEBUG: Edad de la transacci√≥n: ${ageMinutes} minutos`);
          
          if (age > 600000) { // 10 minutos
            out("‚ùå SEGURIDAD: Transacci√≥n expirada (>10 min)");
            return;
          }
        }
        
        // Validaci√≥n 7: Verificar data coincide con nonce
        const dataDecoded = atob(tx.data);
        out("üîç DEBUG: Payload decodificado", { payload: dataDecoded });
        
        if (sessionNonce && !dataDecoded.includes(sessionNonce)) {
          out("‚ùå SEGURIDAD: Data no contiene el nonce esperado");
          return;
        }
        
        // Validaci√≥n 8: Longitud de firma y owner (Base64URL)
        const base64UrlRegex = /^[A-Za-z0-9_-]+$/;
        if (!base64UrlRegex.test(tx.signature)) {
          out("‚ùå SEGURIDAD: Formato de firma inv√°lido");
          return;
        }
        if (!base64UrlRegex.test(tx.owner)) {
          out("‚ùå SEGURIDAD: Formato de owner inv√°lido");
          return;
        }
        
        out("üìÇ Archivo firmado cargado y validado", {
          id: tx.id,
          signatureLength: tx.signature.length,
          ownerLength: tx.owner.length
        });
        
        // Verificar firma criptogr√°fica
        out("üîê DEBUG: Verificando firma criptogr√°fica...");
        const valid = await verifySignature(tx);
        
        if (valid) {
          const signer = await ownerToAddress(tx.owner);
          out("‚úÖ SEGURIDAD: Firma criptogr√°fica V√ÅLIDA", { signer });
          
          // Limpiar sesi√≥n despu√©s de uso exitoso
          sessionNonce = null;
          sessionTimestamp = null;
          out("üßπ DEBUG: Sesi√≥n limpiada");
          
        } else {
          out("‚ùå SEGURIDAD: Firma criptogr√°fica INV√ÅLIDA - transacci√≥n rechazada");
        }
        
      } catch (err) {
        out("‚ùå ERROR al procesar archivo", { 
          error: err.message,
          stack: err.stack,
          name: err.name
        });
      }
    };
    
    // === Utils ===
    async function verifySignature(tx) {
      try {
        await ensureArweaveLoaded();
        
        // Esperar un tick adicional para asegurar que Arweave est√© completamente inicializado
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (!window.Arweave) {
          throw new Error("Arweave library failed to initialize");
        }
        
        const arweave = window.Arweave.init({
          host: 'arweave.net',
          port: 443,
          protocol: 'https'
        });
        
        out("üîç DEBUG: Explorando API de Arweave...", { 
          hasTransactions: !!arweave.transactions,
          transactionsMethods: Object.keys(arweave.transactions || {})
        });
        
        // Usar el m√©todo correcto de la API
        // En lugar de new Transaction(), usamos el objeto tal cual
        const result = await arweave.transactions.verify(tx);
        
        out("üîç DEBUG: Resultado de verificaci√≥n criptogr√°fica", { valid: result });
        return result;
      } catch (err) {
        out("‚ùå ERROR en verificaci√≥n", { 
          error: err.message, 
          stack: err.stack,
          hasArweave: !!window.Arweave
        });
        return false;
      }
    }
    
    async function ownerToAddress(owner) {
      await ensureArweaveLoaded();
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const arweave = window.Arweave.init({
        host: 'arweave.net',
        port: 443,
        protocol: 'https'
      });
      return await arweave.wallets.ownerToAddress(owner);
    }
    
    async function ensureArweaveLoaded() {
      if (!window.Arweave) {
        out("üì¶ DEBUG: Cargando librer√≠a Arweave...");
        
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "https://unpkg.com/arweave@1.14.4/bundles/web.bundle.min.js";
          script.crossOrigin = "anonymous";
          
          script.onload = () => {
            out("‚úÖ DEBUG: Librer√≠a Arweave cargada");
            // Esperar a que el objeto global est√© disponible
            setTimeout(() => {
              if (window.Arweave) {
                resolve();
              } else {
                reject(new Error("Arweave not available after load"));
              }
            }, 200);
          };
          
          script.onerror = () => {
            out("‚ùå ERROR: Fall√≥ la carga de Arweave");
            reject(new Error("Failed to load Arweave library"));
          };
          
          document.body.appendChild(script);
        });
      }
    }
    
    out("üöÄ Sistema iniciado - Modo debug seguro activado");
  </script>
</body>
</html>
