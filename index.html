<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Comentarios con Wander + Arweave (Respuestas)</title>
  <script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    button { margin: 5px; padding: 8px 15px; cursor: pointer; }
    #comments { margin-top: 20px; }
    .comment { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .txid { font-size: 0.8em; color: gray; }
    #debug { margin-top: 30px; background: #111; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>üí¨ Sistema de Comentarios (con Respuestas + Debug)</h2>

  <button id="connectBtn">Conectar Wallet</button>
  <button id="disconnectBtn">Desconectar Wallet</button>
  <p id="walletAddress"></p>

  <textarea id="commentInput" placeholder="Escribe tu comentario..." rows="3" cols="50"></textarea><br>
  <button id="sendCommentBtn">Enviar comentario</button>

  <h3>Comentarios</h3>
  <div id="comments"></div>

  <h3>üîé Debug Log</h3>
  <div id="debug"></div>

  <script>
    const arweave = Arweave.init({
      host: "ar-io.net",
      port: 443,
      protocol: "https"
    });

    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const sendCommentBtn = document.getElementById("sendCommentBtn");
    const walletAddressEl = document.getElementById("walletAddress");
    const commentInput = document.getElementById("commentInput");
    const commentsDiv = document.getElementById("comments");
    const debugDiv = document.getElementById("debug");

    let currentAddress = null;

    function logDebug(msg) {
      console.log(msg);
      debugDiv.textContent += msg + "\n";
    }

    // Conectar wallet
    connectBtn.onclick = async () => {
      try {
        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "DISPATCH"]);
        currentAddress = await window.arweaveWallet.getActiveAddress();
        walletAddressEl.textContent = "Conectado: " + currentAddress;
        logDebug("‚úÖ Wallet conectada: " + currentAddress);
      } catch (err) {
        logDebug("‚ùå Error al conectar: " + err);
      }
    };

    // Desconectar wallet
    disconnectBtn.onclick = async () => {
      try {
        await window.arweaveWallet.disconnect();
        currentAddress = null;
        walletAddressEl.textContent = "Desconectado";
        logDebug("‚ÑπÔ∏è Wallet desconectada.");
      } catch (err) {
        logDebug("‚ùå Error al desconectar: " + err);
      }
    };

    // Enviar comentario (soporta respuestas)
    async function sendComment(replyTo = "origin") {
      const text = commentInput.value.trim();
      if (!text) return alert("Escribe un comentario");

      try {
        const tx = await arweave.createTransaction({ data: text });

        tx.addTag("Content-Type", "text/plain");
        tx.addTag("type", "commentary");
        tx.addTag("to", replyTo); // ra√≠z o respuesta
        tx.addTag("page", window.location.pathname);

        const res = await window.arweaveWallet.dispatch(tx);

        logDebug(`üìù Comentario enviado a "${replyTo}" -> TxID: ${res.id}`);
        alert(`Comentario enviado.\nTxID: ${res.id}`);

        commentInput.value = "";
        loadComments();
      } catch (err) {
        logDebug("‚ùå Error al enviar comentario: " + err);
      }
    }

    sendCommentBtn.onclick = () => sendComment("origin");

    // Cargar comentarios desde Arweave
    async function loadComments() {
      commentsDiv.innerHTML = "Cargando comentarios...";
      logDebug("üîÑ Cargando comentarios...");

      const query = {
        query: `
          query {
            transactions(
              tags: [
                { name: "type", values: ["commentary"] },
                { name: "page", values: ["${window.location.pathname}"] }
              ],
              first: 100,
              sort: HEIGHT_DESC
            ) {
              edges {
                node {
                  id
                  owner { address }
                  tags { name value }
                }
              }
            }
          }
        `
      };

      try {
        const response = await fetch("https://arweave.net/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(query),
        });

        const result = await response.json();
        const edges = result.data.transactions.edges;

        commentsDiv.innerHTML = "";
        if (edges.length === 0) {
          commentsDiv.textContent = "No hay comentarios todav√≠a.";
          logDebug("‚ö†Ô∏è No hay comentarios.");
          return;
        }

        // Mapear comentarios por ID y agrupar hijos
        const commentsMap = {};
        for (const edge of edges) {
          const node = edge.node;
          const toTag = node.tags.find(t => t.name === "to")?.value || "origin";

          commentsMap[node.id] = { node, children: [] };

          if (toTag !== "origin") {
            if (!commentsMap[toTag]) commentsMap[toTag] = { children: [] };
            commentsMap[toTag].children.push(node);
          }
        }

        // Renderizar solo los comentarios ra√≠z
        for (const edge of edges) {
          const node = edge.node;
          const toTag = node.tags.find(t => t.name === "to")?.value || "origin";
          if (toTag !== "origin") continue;
          await renderComment(node, commentsDiv, commentsMap);
        }

      } catch (err) {
        logDebug("‚ùå Error al cargar comentarios: " + err);
        commentsDiv.textContent = "Error al cargar comentarios.";
      }
    }

    // Renderizar comentario y sus respuestas
    async function renderComment(node, container, commentsMap, depth = 0) {
      const text = await fetch(`https://arweave.net/${node.id}`).then(r => r.text());
      const div = document.createElement("div");
      div.className = "comment";
      div.style.marginLeft = `${depth * 20}px`;
      div.innerHTML = `
        <p>${text}</p>
        <p class="txid">üë§ ${node.owner.address}<br>
        TxID: <a href="https://arweave.net/${node.id}" target="_blank">${node.id}</a></p>
        <button class="replyBtn">‚Ü©Ô∏è Responder</button>
      `;

      const replyBtn = div.querySelector(".replyBtn");
      replyBtn.onclick = () => {
        commentInput.value = `@${node.owner.address} `;
        sendComment(node.id);
      };

      container.appendChild(div);

      // Renderizar hijos (respuestas)
      for (const child of commentsMap[node.id]?.children || []) {
        await renderComment(child, container, commentsMap, depth + 1);
      }
    }

    // Al cargar la p√°gina
    loadComments();
  </script>
</body>
</html>
