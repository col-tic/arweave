<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Comentarios con Arweave</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #connectBtn { background: #28a745; color: white; }
    #disconnectBtn { background: #dc3545; color: white; }
    #sendBtn { background: #007bff; color: white; }
    textarea {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .comment {
      border: 1px solid #444;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #1a1a1a;
    }
    .comment a {
      color: #0af;
      text-decoration: none;
    }
    .comment a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>üí¨ Sistema de Comentarios en Arweave</h1>

  <!-- Botones -->
  <button id="connectBtn">Conectar Wallet</button>
  <button id="disconnectBtn" disabled>Desconectar Wallet</button>

  <!-- Estado -->
  <p id="walletAddress">Wallet: ‚ùå no conectada</p>

  <!-- Formulario comentario -->
  <textarea id="commentInput" placeholder="Escribe tu comentario..."></textarea>
  <br>
  <button id="sendBtn" disabled>Enviar Comentario</button>

  <h2>üìú Comentarios</h2>
  <div id="comments"></div>

  <script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
  <script>
    let walletAddress = null;

    // === Conectar wallet ===
    document.getElementById("connectBtn").onclick = async () => {
      try {
        const permissions = ["ACCESS_ADDRESS", "SIGN_TRANSACTION"];
        walletAddress = await window.arweaveWallet.connect(permissions);
        document.getElementById("walletAddress").innerText = "Wallet: üë§ " + walletAddress;
        document.getElementById("connectBtn").disabled = true;
        document.getElementById("disconnectBtn").disabled = false;
        document.getElementById("sendBtn").disabled = false;
      } catch (err) {
        console.error("Error conectando wallet:", err);
      }
    };

    // === Desconectar wallet ===
    document.getElementById("disconnectBtn").onclick = async () => {
      try {
        await window.arweaveWallet.disconnect();
        walletAddress = null;
        document.getElementById("walletAddress").innerText = "Wallet: ‚ùå no conectada";
        document.getElementById("connectBtn").disabled = false;
        document.getElementById("disconnectBtn").disabled = true;
        document.getElementById("sendBtn").disabled = true;
      } catch (err) {
        console.error("Error desconectando wallet:", err);
      }
    };

    // === Enviar comentario ===
    document.getElementById("sendBtn").onclick = async () => {
      const text = document.getElementById("commentInput").value.trim();
      if (!text) return alert("Escribe un comentario antes de enviar.");
      if (!walletAddress) return alert("Conecta tu wallet primero.");

      try {
        const tx = await arweave.createTransaction({ data: text });
        tx.addTag("Content-Type", "text/plain");
        tx.addTag("type", "commentary");
        tx.addTag("to", "origin"); // por ahora todos los comentarios son ra√≠z

        await window.arweaveWallet.signTransaction(tx);
        const response = await arweave.transactions.post(tx);

        console.log("Tx enviada:", response);
        addCommentToDOM(walletAddress, text, tx.id, "origin", "commentary");

        document.getElementById("commentInput").value = "";
      } catch (err) {
        console.error("Error enviando comentario:", err);
      }
    };

    // === Mostrar un comentario en el DOM (con debug) ===
    function addCommentToDOM(wallet, content, txId, to, type) {
      const commentsDiv = document.getElementById("comments");
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `
        <p><strong>üë§ ${wallet}</strong></p>
        <p>${content}</p>
        <p>üîó TxID: <a href="https://arweave.net/${txId}" target="_blank">${txId}</a></p>
        <p>üìå To: ${to}</p>
        <p>üè∑Ô∏è Type: ${type}</p>
      `;
      commentsDiv.prepend(div); // el √∫ltimo comentario arriba
    }

    // === Inicializar Arweave ===
    const arweave = Arweave.init({
      host: "arweave.net",
      port: 443,
      protocol: "https"
    });

    // üîÆ TODO: aqu√≠ podr√≠as cargar comentarios previos desde GraphQL y llamas addCommentToDOM
  </script>
</body>
</html>
