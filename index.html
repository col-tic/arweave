<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Wander Connect Debug</title>
<script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
</head>
<body>

<h1>Wander Connect — Debug</h1>

<div>
  <h2>MÉTODO 2: Firma Offline (Descargar/Cargar JSON)</h2>
  <button id="generateJsonBtn">1. Generar JSON para firmar</button>
  <button id="uploadSignedBtn">2. Cargar JSON firmado</button>
  <input type="file" id="fileInput" accept=".json" style="display:none">
</div>

<pre id="terminal">[INFO] Terminal iniciado…</pre>

<script>
const term = document.getElementById('terminal');

function log(msg, type='info') {
  const ts = new Date().toISOString();
  term.textContent += `\n[${ts}][${type.toUpperCase()}] ${msg}`;
  term.scrollTop = term.scrollHeight;
}

// ============================================
// GENERAR JSON PARA FIRMAR OFFLINE
// ============================================
document.getElementById('generateJsonBtn').addEventListener('click', async () => {
  try {
    log('Generando JSON para firma de autenticación...', 'event');
    
    const timestamp = Date.now();
    const authMessage = {
      app: 'WanderConnect',
      action: 'authenticate',
      timestamp: timestamp,
      message: 'Firma este mensaje para autenticarte en WanderConnect'
    };
    
    const firmarJson = { data: authMessage, timestamp: timestamp };
    
    const blob = new Blob([JSON.stringify(firmarJson, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'firmar.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    log('✅ Archivo firmar.json descargado', 'info');
    log('Instrucciones: firma el archivo con tu wallet usando Python y luego cárgalo aquí', 'event');
  } catch (e) {
    log('Error generando JSON => ' + e.message, 'err');
    console.error(e);
  }
});

// ============================================
// CARGAR JSON FIRMADO
// ============================================
document.getElementById('uploadSignedBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    log('Cargando JSON firmado...', 'event');
    
    const text = await file.text();
    const signedData = JSON.parse(text);
    
    log('JSON cargado con éxito', 'info');
    
    if (!signedData.signature) {
      log('❌ El JSON no contiene firma. Debes firmarlo primero con Python.', 'err');
      return;
    }
    
    if (!signedData.address) {
      log('❌ El JSON no contiene la dirección de la wallet.', 'err');
      return;
    }
    
    log('✅ Firma válida detectada', 'info');
    log('Dirección autenticada: ' + signedData.address, 'event');
    log('Signature ID: ' + signedData.id, 'info');
    log('✅ AUTENTICACIÓN EXITOSA', 'event');
  } catch (e) {
    log('Error procesando JSON firmado => ' + e.message, 'err');
    console.error(e);
  }
  
  e.target.value = '';
});
</script>

</body>
</html>
