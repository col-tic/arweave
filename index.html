<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login seguro con Arweave</title>
  <script type="module" src="https://esm.sh/arweave"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f6fa;
      padding: 2rem;
      color: #222;
    }
    h2 { color: #444; }
    button {
      background: #4a6cf7;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      margin: 0.3rem;
      cursor: pointer;
    }
    button:hover { background: #3952d4; }
    input[type=file] { margin-top: 1rem; }
    pre {
      background: #222;
      color: #0f0;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      height: 200px;
    }
  </style>
</head>
<body>

  <h1>üîê Sistema de login seguro Arweave</h1>

  <h2>M√©todo 1: ArConnect / Wallet del navegador</h2>
  <button id="login-wallet">Conectarse con wallet</button>

  <h2>M√©todo 2: Firma externa (Python)</h2>
  <button id="generar">üßæ Generar archivo para firmar</button>
  <br>
  <input type="file" id="upload" accept=".json">

  <h3>Logs</h3>
  <pre id="log"></pre>

  <script type="module">
    import Arweave from "https://esm.sh/arweave";

    const arweave = Arweave.init();
    const logBox = document.getElementById("log");
    const log = (...msg) => {
      console.log(...msg);
      logBox.textContent += msg.join(" ") + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    let sessionNonce = null;

    // ------------------------
    // M√âTODO 1: ArConnect
    // ------------------------
    const btnWallet = document.getElementById("login-wallet");
    btnWallet.onclick = async () => {
      if (!window.arweaveWallet) {
        log("‚ùå No se detect√≥ ArConnect.");
        alert("Instala la extensi√≥n ArConnect para usar este m√©todo.");
        return;
      }

      try {
        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "SIGNATURE"]);
        const address = await window.arweaveWallet.getActiveAddress();
        log("‚úÖ Conectado con ArConnect:", address);

        // Generar mensaje simple para firmar
        const msg = `login-${Date.now()}-${crypto.randomUUID()}`;
        const data = new TextEncoder().encode(msg);

        const signature = await window.arweaveWallet.signature(data, {
          name: "RSA-PSS",
          saltLength: 32,
        });

        const pubkey = await window.arweaveWallet.getActivePublicKey();
        const verified = await arweave.crypto.verify(pubkey, data, signature);

        if (verified) {
          log("‚úÖ Firma verificada correctamente.");
        } else {
          log("‚ùå Firma inv√°lida.");
        }
      } catch (err) {
        log("‚ùå Error con wallet:", err);
      }
    };

    // ------------------------
    // M√âTODO 2: Firma externa (Python)
    // ------------------------
    document.getElementById("generar").onclick = () => {
      sessionNonce = crypto.randomUUID();
      const timestamp = Date.now();

      const data = {
        action: "login-request",
        nonce: sessionNonce,
        timestamp,
        tags: [
          { name: "App-Name", value: "DemoLogin" },
          { name: "Login-Type", value: "ExternalSignature" },
        ],
      };

      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);

      log("üìÑ Archivo firmar.json generado.");
      log(JSON.stringify(data, null, 2));
    };

    // Cargar archivo firmado desde Python
    document.getElementById("upload").onchange = async (e) => {
      const file = e.target.files[0];
      const text = await file.text();
      const tx = JSON.parse(text);

      log("üìÇ Archivo firmado cargado.");
      log(JSON.stringify(tx, null, 2));

      try {
        // Verificar nonce
        if (!tx.data) throw new Error("Campo 'data' ausente.");
        const decoded = JSON.parse(tx.data);
        if (decoded.nonce !== sessionNonce) {
          log("‚ùå Nonce inv√°lido o sesi√≥n distinta.");
          return;
        }

        // Verificar firma con arweave-js
        const ok = await arweave.transactions.verify(tx);
        if (ok) {
          log("‚úÖ Firma criptogr√°fica v√°lida.");
        } else {
          log("‚ùå Firma criptogr√°fica inv√°lida.");
        }
      } catch (err) {
        log("‚ùå Error verificando:", err.message);
      }
    };
  </script>
</body>
</html>

