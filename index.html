<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artube - Mi App Arweave</title>
<script src="https://cdn.jsdelivr.net/npm/arweave@1.16.0/bundles/arweave.bundle.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button { margin: 5px 0; padding: 5px 10px; }
  img { max-width: 200px; margin: 10px 0; display: block; }
  .image-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
  .reply { margin-left: 20px; font-size: 14px; background: #f4f4f4; padding: 5px; }
  .log { background: #eee; padding: 10px; margin-top: 10px; max-height: 200px; overflow: auto; font-size: 12px; }
</style>
</head>
<body>

<h1>Artube - Mi App Arweave</h1>

<button onclick="connectWallet()">Conectar Wallet</button>
<button onclick="disconnectWallet()">Desconectar Wallet</button>
<p id="wallet-address">Wallet no conectada</p>

<h2>Subir imagen</h2>
<input type="file" id="fileInput" accept="image/*">
<button onclick="uploadImage()">Subir</button>

<h2>Imágenes publicadas</h2>
<div id="imagesContainer"></div>

<h2>Debug log</h2>
<div id="log" class="log"></div>

<script>
const arweave = Arweave.init({ host: 'arweave.net', port: 443, protocol: 'https' });
let walletAddress = null;

function log(message) {
  const logDiv = document.getElementById('log');
  const p = document.createElement('p');
  p.textContent = message;
  logDiv.appendChild(p);
  console.log(message);
}

async function connectWallet() {
  log("Intentando conectar wallet...");
  if (window.arweaveWallet) {
    try {
      await window.arweaveWallet.connect(['ACCESS_ADDRESS','SIGN_TRANSACTION']);
      walletAddress = await window.arweaveWallet.getActiveAddress();
      document.getElementById('wallet-address').innerText = "Wallet conectada: " + walletAddress;
      log("Wallet conectada: " + walletAddress);
      loadImages();
    } catch(e) {
      log("Error conectando wallet: " + e);
    }
  } else {
    alert("Instala ArConnect para continuar.");
    log("ArConnect no encontrado.");
  }
}

async function disconnectWallet() {
  if (window.arweaveWallet) {
    try {
      await window.arweaveWallet.disconnect();
      walletAddress = null;
      document.getElementById('wallet-address').innerText = "Wallet desconectada";
      log("Wallet desconectada.");
      document.getElementById('imagesContainer').innerHTML = '';
    } catch(e) {
      log("Error desconectando wallet: " + e);
    }
  }
}

async function uploadImage() {
  if (!walletAddress) return alert("Conecta primero la wallet");

  const file = document.getElementById('fileInput').files[0];
  if (!file) return alert("Selecciona un archivo");

  log("Archivo seleccionado: " + file.name + ", tamaño: " + file.size + " bytes");

  const reader = new FileReader();
  reader.onload = async function(event) {
    const arrayBuffer = event.target.result;

    const transaction = await arweave.createTransaction({ data: arrayBuffer });
    transaction.addTag('App-Name', 'artube');  // Clave de tu sitio
    transaction.addTag('Type', 'Image');
    transaction.addTag('Content-Type', file.type); // MIME correcto

    log("Transacción creada, id temporal: " + transaction.id);

    try {
      await window.arweaveWallet.sign(transaction);
      log("Transacción firmada correctamente: " + transaction.isSigned);

      const response = await arweave.transactions.post(transaction);
      log("Transacción enviada, status: " + response.status);
      if (response.status === 200) {
        alert("Imagen subida!");
        log("Imagen subida con ID: " + transaction.id);
        loadImages();
      } else {
        alert("Error al subir: " + response.statusText);
        log("Error enviando transacción: " + response.status + " - " + response.statusText);
      }
    } catch(e) {
      log("Error durante la firma o envío: " + e);
    }
  };
  reader.readAsArrayBuffer(file);
}

async function loadImages() {
  log("Cargando imágenes publicadas...");
  const query = {
    op: "and",
    expr1: { op: "equals", expr1: "App-Name", expr2: "artube" },
    expr2: { op: "equals", expr1: "Type", expr2: "Image" }
  };
  try {
    const txs = await arweave.api.post('/arql', query);
    const container = document.getElementById('imagesContainer');
    container.innerHTML = '';
    log("Transacciones encontradas: " + (txs.data ? txs.data.length : 0));

    if (!txs.data || txs.data.length === 0) return container.innerText = "No hay imágenes";

    for (const txId of txs.data) {
      try {
        const imageUrl = `https://arweave.net/${txId}`;
        const div = document.createElement('div');
        div.className = 'image-card';
        div.innerHTML = `
          <img src="${imageUrl}" alt="Imagen Arweave">
          <p>ID: ${txId}</p>
          <button onclick="replyToImage('${txId}')">Responder</button>
          <div id="replies-${txId}"></div>
        `;
        container.appendChild(div);
        loadReplies(txId);
      } catch(e) {
        log("Error mostrando transacción " + txId + ": " + e);
      }
    }
  } catch(e) {
    log("Error consultando transacciones: " + e);
  }
}

async function replyToImage(txId) {
  if (!walletAddress) return alert("Conecta primero la wallet");

  const text = prompt("Escribe tu respuesta:");
  if (!text) return;

  const transaction = await arweave.createTransaction({ data: text });
  transaction.addTag('App-Name', 'artube');  // Clave de tu sitio
  transaction.addTag('Type', 'Reply');
  transaction.addTag('Reply-To', txId);

  try {
    log("Firmando respuesta...");
    await window.arweaveWallet.sign(transaction);
    log("Respuesta firmada, id: " + transaction.id);

    const response = await arweave.transactions.post(transaction);
    log("Respuesta enviada, status: " + response.status);
    if (response.status === 200) {
      alert("Respuesta enviada!");
      loadReplies(txId);
    } else alert("Error al enviar: " + response.statusText);
  } catch(e) {
    log("Error enviando respuesta: " + e);
  }
}

async function loadReplies(txId) {
  const repliesContainer = document.getElementById(`replies-${txId}`);
  repliesContainer.innerHTML = '';
  const query = {
    op: "and",
    expr1: { op: "equals", expr1: "App-Name", expr2: "artube" },
    expr2: { op: "and",
      expr1: { op: "equals", expr1: "Type", expr2: "Reply" },
      expr2: { op: "equals", expr1: "Reply-To", expr2: txId }
    }
  };
  try {
    const txs = await arweave.api.post('/arql', query);
    if (!txs.data || txs.data.length === 0) return;
    for (const replyId of txs.data) {
      try {
        const replyData = await arweave.transactions.getData(replyId, {decode: true, string: true});
        const div = document.createElement('div');
        div.className = 'reply';
        div.textContent = replyData;
        repliesContainer.appendChild(div);
      } catch(e) {
        log("Error cargando respuesta " + replyId + ": " + e);
      }
    }
  } catch(e) {
    log("Error consultando respuestas: " + e);
  }
}
</script>

</body>
</html>
