<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auth Debug - Wander / JSON firmado</title>
</head>
<body>
  <h2>ðŸ§© AutenticaciÃ³n Debug</h2>

  <h3>MÃ©todo 1: Conectar con Wander</h3>
  <button id="connectBtn">Conectar con Wander</button>

  <h3>MÃ©todo 2: Archivo firmado manualmente</h3>
  <button id="generateBtn">Generar firmar.json</button>
  <input type="file" id="fileInput" accept=".json" />
  <pre id="output"></pre>

  <script>
    const out = (msg, data) => {
      const pre = document.getElementById("output");
      pre.textContent += "\n" + msg + (data ? "\n" + JSON.stringify(data, null, 2) : "");
    };

    const connectBtn = document.getElementById("connectBtn");
    const generateBtn = document.getElementById("generateBtn");
    const fileInput = document.getElementById("fileInput");

    // === MÃ‰TODO 1: Conectar con Wander ===
    connectBtn.onclick = async () => {
      if (!window.arweaveWallet) {
        alert("Instala la extensiÃ³n Wander primero.");
        return;
      }
      try {
        await window.arweaveWallet.connect(["ACCESS_ADDRESS"]);
        const address = await window.arweaveWallet.getActiveAddress();
        out("âœ… Conectado con Wander", { address });
      } catch (e) {
        out("âŒ Error al conectar", { error: e.message });
      }
    };

    // === MÃ‰TODO 2: AutenticaciÃ³n manual ===

    // Genera archivo sin firmar
    generateBtn.onclick = () => {
      const tx = {
        format: 2,
        owner: "",
        target: "",
        quantity: "0",
        data: btoa("login-request-" + Date.now()),
        reward: "0",
        last_tx: "",
        tags: [
          { name: "App-Name", value: "ManualLogin" },
          { name: "Content-Type", value: "text/plain" },
        ],
      };
      const blob = new Blob([JSON.stringify(tx, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.click();
      out("ðŸ“„ Archivo generado: firmar.json");
    };

    // Cargar archivo firmado
    fileInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const tx = JSON.parse(text);
        out("ðŸ“‚ Archivo firmado cargado", tx);

        if (!tx.signature) {
          out("âŒ El JSON no contiene firma");
          return;
        }

        // Verificar firma
        const valid = await verifySignature(tx);
        if (valid) {
          const signer = await ownerToAddress(tx.owner);
          out("âœ… Firma vÃ¡lida", { signer });
        } else {
          out("âŒ Firma invÃ¡lida");
        }
      } catch (err) {
        out("âŒ Error al procesar archivo", { error: err.message });
      }
    };

    // === Utils ===
    async function verifySignature(tx) {
      await ensureArweaveLoaded();
      const arweave = window.Arweave.init();
      return await arweave.transactions.verify(tx);
    }

    async function ownerToAddress(owner) {
      await ensureArweaveLoaded();
      const arweave = window.Arweave.init();
      return await arweave.wallets.ownerToAddress(owner);
    }

    async function ensureArweaveLoaded() {
      if (!window.Arweave) {
        const script = document.createElement("script");
        script.src = "https://unpkg.com/arweave@1.14.4/bundles/web.bundle.min.js";
        document.body.appendChild(script);
        await new Promise(r => script.onload = r);
      }
    }
  </script>
</body>
</html>
