<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login seguro con Arweave</title>
  <script type="module" src="https://esm.sh/arweave"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f6f8;
      padding: 2rem;
      color: #222;
    }
    h2 { margin-top: 2rem; }
    button {
      background: #405cf5;
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.3rem;
    }
    button:hover { background: #2e45c2; }
    pre {
      background: #111;
      color: #0f0;
      padding: 1rem;
      border-radius: 8px;
      overflow-y: auto;
      height: 240px;
    }
  </style>
</head>
<body>
  <h1>üîê Sistema de Login Seguro - Arweave</h1>

  <h2>M√©todo 1: Login con Wallet (ArConnect)</h2>
  <button id="login-wallet">Conectarse con wallet</button>

  <h2>M√©todo 2: Firma Externa (Python signer)</h2>
  <button id="generar">üßæ Generar archivo para firmar</button><br>
  <input type="file" id="upload" accept=".json" />

  <h3>Logs</h3>
  <pre id="log"></pre>

  <script type="module">
    import Arweave from "https://esm.sh/arweave";

    const arweave = Arweave.init();
    const logBox = document.getElementById("log");
    const log = (...msg) => {
      console.log(...msg);
      logBox.textContent += msg.join(" ") + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    };

    let sessionNonce = null;

    // -----------------------------
    // M√âTODO 1: LOGIN CON WALLET
    // -----------------------------
    document.getElementById("login-wallet").onclick = async () => {
      if (!window.arweaveWallet) {
        alert("Por favor instala la extensi√≥n ArConnect.");
        return;
      }

      try {
        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "SIGNATURE"]);
        const address = await window.arweaveWallet.getActiveAddress();
        log(`‚úÖ Wallet conectada: ${address}`);

        const msg = `login-${Date.now()}-${crypto.randomUUID()}`;
        const encoded = new TextEncoder().encode(msg);
        const signature = await window.arweaveWallet.signature(encoded, {
          name: "RSA-PSS",
          saltLength: 32,
        });
        const pubKey = await window.arweaveWallet.getActivePublicKey();
        const verified = await arweave.crypto.verify(pubKey, encoded, signature);

        log(verified ? "‚úÖ Firma v√°lida" : "‚ùå Firma inv√°lida");
      } catch (err) {
        log("‚ùå Error con wallet:", err);
      }
    };

    // -----------------------------
    // M√âTODO 2: FIRMA EXTERNA
    // -----------------------------
    document.getElementById("generar").onclick = () => {
      sessionNonce = crypto.randomUUID();
      const payload = {
        action: "login-request",
        nonce: sessionNonce,
        timestamp: Date.now(),
        tags: [
          { name: "App-Name", value: "DemoLogin" },
          { name: "Login-Type", value: "ExternalSignature" },
        ],
      };

      const jsonStr = JSON.stringify(payload, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.click();
      URL.revokeObjectURL(a.href);

      log("üìÑ Archivo firmar.json generado.");
      log(JSON.stringify(payload, null, 2));
    };

    // Subir archivo firmado desde Python
    document.getElementById("upload").onchange = async (e) => {
      const file = e.target.files[0];
      const text = await file.text();
      let tx;

      try {
        tx = JSON.parse(text);
      } catch {
        log("‚ùå Archivo JSON inv√°lido.");
        return;
      }

      log("üìÇ Archivo firmado cargado.");

      try {
        // --- decodificar data ---
        const decoded = atob(tx.data);
        const inner = JSON.parse(decoded);
        log("üìú Payload decodificado:");
        log(JSON.stringify(inner, null, 2));

        // --- verificar nonce ---
        if (inner.nonce !== sessionNonce) {
          log("‚ùå Nonce no coincide o sesi√≥n distinta.");
          return;
        }

        // --- verificar firma ---
        const ok = await arweave.transactions.verify(tx);
        log(ok ? "‚úÖ Firma criptogr√°fica v√°lida." : "‚ùå Firma criptogr√°fica inv√°lida.");
      } catch (err) {
        log("‚ùå Error verificando:", err.message);
      }
    };
  </script>
</body>
</html>

