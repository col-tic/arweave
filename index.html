<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Comentarios con Wander + Arweave</title>
  <script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    button { margin: 5px; padding: 8px 15px; cursor: pointer; }
    #comments { margin-top: 20px; }
    .comment { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .txid { font-size: 0.8em; color: gray; }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Sistema de Comentarios</h2>

  <button id="connectBtn">Conectar Wallet</button>
  <button id="disconnectBtn">Desconectar Wallet</button>
  <p id="walletAddress"></p>

  <textarea id="commentInput" placeholder="Escribe tu comentario..." rows="3" cols="50"></textarea><br>
  <button id="sendCommentBtn">Enviar comentario</button>

  <h3>Comentarios</h3>
  <div id="comments"></div>

  <script>
    const arweave = Arweave.init({
      host: "ar-io.net",
      port: 443,
      protocol: "https"
    });

    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const sendCommentBtn = document.getElementById("sendCommentBtn");
    const walletAddressEl = document.getElementById("walletAddress");
    const commentInput = document.getElementById("commentInput");
    const commentsDiv = document.getElementById("comments");

    let currentAddress = null;

    // Conectar wallet
    connectBtn.onclick = async () => {
      try {
        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "DISPATCH"]);
        currentAddress = await window.arweaveWallet.getActiveAddress();
        walletAddressEl.textContent = "Conectado: " + currentAddress;
      } catch (err) {
        console.error("Error al conectar:", err);
      }
    };

    // Desconectar wallet
    disconnectBtn.onclick = async () => {
      try {
        await window.arweaveWallet.disconnect();
        currentAddress = null;
        walletAddressEl.textContent = "Desconectado";
      } catch (err) {
        console.error("Error al desconectar:", err);
      }
    };

    // Enviar comentario
    sendCommentBtn.onclick = async () => {
      const text = commentInput.value.trim();
      if (!text) return alert("Escribe un comentario");

      try {
        const tx = await arweave.createTransaction({ data: text });

        // Etiquetas para identificarlo como comentario
        tx.addTag("Content-Type", "text/plain");
        tx.addTag("type", "commentary");
        tx.addTag("to", "origin"); // por ahora todos van a origin
        tx.addTag("page", window.location.pathname);

        const res = await window.arweaveWallet.dispatch(tx);

        console.log("Comentario enviado:", res);
        alert(`Comentario enviado.\nTxID: ${res.id} | type: ${res.type}`);
        commentInput.value = "";
        loadComments(); // recargar lista
      } catch (err) {
        console.error("Error al enviar comentario:", err);
      }
    };

    // Cargar comentarios desde Arweave GraphQL
    async function loadComments() {
      commentsDiv.innerHTML = "Cargando comentarios...";

      const query = {
        query: `
          query {
            transactions(
              tags: [
                { name: "type", values: ["commentary"] },
                { name: "to", values: ["origin"] },
                { name: "page", values: ["${window.location.pathname}"] }
              ],
              first: 50,
              sort: HEIGHT_DESC
            ) {
              edges {
                node {
                  id
                  owner { address }
                  tags { name value }
                }
              }
            }
          }
        `
      };

      try {
        const response = await fetch("https://arweave.net/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(query),
        });

        const result = await response.json();
        const edges = result.data.transactions.edges;

        commentsDiv.innerHTML = "";
        if (edges.length === 0) {
          commentsDiv.textContent = "No hay comentarios todavÃ­a.";
          return;
        }

        for (const edge of edges) {
          const commentText = await fetch(`https://arweave.net/${edge.node.id}`).then(r => r.text());
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `
            <p>${commentText}</p>
            <p class="txid">ðŸ‘¤ ${edge.node.owner.address}<br>TxID: ${edge.node.id}</p>
          `;
          commentsDiv.appendChild(div);
        }
      } catch (err) {
        console.error("Error al cargar comentarios:", err);
        commentsDiv.textContent = "Error al cargar comentarios.";
      }
    }

    // Al cargar la pÃ¡gina
    loadComments();
  </script>
</body>
</html>
