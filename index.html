<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wander Connect Debug</title>
<style>
  body{font-family:monospace;background:#000;color:#0f0;margin:0;padding:20px}
  h1{text-align:center;text-shadow:0 0 10px #00FF00}
  .ribbon{background:#111;padding:12px;border-radius:6px;text-align:center;margin-bottom:10px}
  button{background:none;border:2px solid #00FF00;color:#00FF00;padding:10px 18px;border-radius:6px;cursor:pointer;margin:5px}
  button:hover{background:#00FF00;color:#000}
  #terminal{background:#060606;border:1px solid #003300;color:#A6FFA6;padding:10px;height:400px;overflow:auto;white-space:pre-wrap;margin-top:10px;border-radius:6px}
  .method-section{background:#111;padding:15px;border-radius:6px;margin-bottom:10px;border:1px solid #003300}
  .method-title{color:#00FF00;font-weight:bold;font-size:16px;margin-bottom:10px}
</style>
<script src="https://unpkg.com/arweave/bundles/web.bundle.min.js"></script>
</head>
<body>
  <h1>Wander Connect — Debug</h1>
  
  <div class="method-section">
    <div class="method-title">MÉTODO 1: Conexión Directa con Wander Extension</div>
    <button id="connectBtn">Connect to Wander</button>
  </div>

  <div class="method-section">
    <div class="method-title">MÉTODO 2: Firma Offline (Descargar/Cargar JSON)</div>
    <button id="generateJsonBtn">1. Generar JSON para firmar</button>
    <button id="uploadSignedBtn">2. Cargar JSON firmado</button>
    <input type="file" id="fileInput" accept=".json" style="display:none">
  </div>

  <div id="terminal">[INFO] Terminal iniciado…</div>

<script>
const term = document.getElementById('terminal');
function log(msg, type='info') {
  const ts = new Date().toISOString();
  const color = type==='err' ? '#FF5555' : type==='event' ? '#55FFFF' : '#A6FFA6';
  term.innerHTML += `\n<span style="color:${color}">${ts} [${type.toUpperCase()}] ${msg}</span>`;
  term.scrollTop = term.scrollHeight;
}

// Detect if wallet is installed
if (!window.arweaveWallet) {
  log('❌ Wander wallet no detectada. Instálala primero desde Chrome Web Store.', 'err');
} else {
  log('✅ Wander wallet detectada. Listo para conectar.', 'info');
}

// ============================================
// MÉTODO 1: Conexión directa con Wander
// ============================================
document.getElementById('connectBtn').addEventListener('click', async () => {
  try {
    log('Solicitando conexión a Wander...', 'event');
    const perms = ["ACCESS_ADDRESS", "SIGN_TRANSACTION"];
    const res = await window.arweaveWallet.connect(perms);
    log('Respuesta connect() => ' + JSON.stringify(res, null, 2), 'info');
    const addr = await window.arweaveWallet.getActiveAddress();
    log('Dirección activa => ' + addr, 'info');
  } catch (e) {
    log('Error durante conexión => ' + e.message, 'err');
    console.error(e);
  }
});

// ============================================
// MÉTODO 2: Generar JSON para firmar offline
// ============================================
document.getElementById('generateJsonBtn').addEventListener('click', async () => {
  try {
    log('Generando JSON para firma offline...', 'event');
    
    // Solicitar dirección del destinatario
    const toAddress = prompt('Ingresa la dirección destino:');
    if (!toAddress) {
      log('Operación cancelada por el usuario', 'err');
      return;
    }
    
    // Solicitar cantidad en AR
    const amountAR = prompt('Ingresa la cantidad en AR (ej: 0.001):', '0.001');
    if (!amountAR) {
      log('Operación cancelada por el usuario', 'err');
      return;
    }
    
    // Crear instancia de Arweave
    const arweave = Arweave.init({
      host: 'arweave.net',
      port: 443,
      protocol: 'https'
    });
    
    // Crear transacción sin wallet
    const transaction = await arweave.createTransaction({
      target: toAddress,
      quantity: arweave.ar.arToWinston(amountAR)
    });
    
    // Agregar tags opcionales
    transaction.addTag('App-Name', 'WanderConnect');
    transaction.addTag('Type', 'offline-signature');
    transaction.addTag('Timestamp', Date.now().toString());
    
    // Convertir transacción a JSON
    const txJson = transaction.toJSON();
    
    // Crear objeto para firmar (compatible con arweave-python-client)
    const firmarJson = {
      format: txJson.format,
      id: txJson.id,
      last_tx: txJson.last_tx,
      owner: txJson.owner,
      tags: txJson.tags,
      target: txJson.target,
      quantity: txJson.quantity,
      data: txJson.data,
      data_size: txJson.data_size,
      data_root: txJson.data_root,
      reward: txJson.reward,
      signature: txJson.signature
    };
    
    // Crear blob y descargar
    const blob = new Blob([JSON.stringify(firmarJson, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'firmar.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    log('✅ Archivo firmar.json descargado', 'info');
    log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
    log('INSTRUCCIONES PARA FIRMAR EN PC:', 'event');
    log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
    log('1. Instala: pip install arweave-python-client', 'info');
    log('2. Ejecuta este código Python:', 'info');
    log('', 'info');
    log('import arweave', 'info');
    log('import json', 'info');
    log('', 'info');
    log('wallet = arweave.Wallet("tu_wallet.json")', 'info');
    log('', 'info');
    log('with open("firmar.json", "r") as f:', 'info');
    log('    tx_data = json.load(f)', 'info');
    log('', 'info');
    log('transaction = arweave.Transaction(', 'info');
    log('    wallet,', 'info');
    log('    quantity=float(tx_data["quantity"])/1e12,', 'info');
    log('    to=tx_data["target"]', 'info');
    log(')', 'info');
    log('', 'info');
    log('for tag in tx_data.get("tags", []):', 'info');
    log('    transaction.add_tag(tag["name"], tag["value"])', 'info');
    log('', 'info');
    log('transaction.sign()', 'info');
    log('', 'info');
    log('signed_tx = {', 'info');
    log('    "id": transaction.id,', 'info');
    log('    "last_tx": transaction.last_tx,', 'info');
    log('    "owner": transaction.owner,', 'info');
    log('    "tags": transaction.tags,', 'info');
    log('    "target": transaction.target,', 'info');
    log('    "quantity": transaction.quantity,', 'info');
    log('    "data": transaction.data,', 'info');
    log('    "data_size": transaction.data_size,', 'info');
    log('    "data_root": transaction.data_root,', 'info');
    log('    "reward": transaction.reward,', 'info');
    log('    "signature": transaction.signature', 'info');
    log('}', 'info');
    log('', 'info');
    log('with open("firmado.json", "w") as f:', 'info');
    log('    json.dump(signed_tx, f, indent=2)', 'info');
    log('', 'info');
    log('print(f"✅ TX ID: {transaction.id}")', 'info');
    log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
    log('3. Carga el archivo firmado.json aquí', 'event');
    
  } catch (e) {
    log('Error generando JSON => ' + e.message, 'err');
    console.error(e);
  }
});

// ============================================
// MÉTODO 2: Cargar JSON firmado
// ============================================
document.getElementById('uploadSignedBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  try {
    log('Cargando JSON firmado...', 'event');
    
    const text = await file.text();
    const signedTx = JSON.parse(text);
    
    log('JSON cargado con éxito', 'info');
    log('TX ID: ' + signedTx.id, 'info');
    
    // Validar que tenga firma
    if (!signedTx.signature) {
      log('❌ El JSON no contiene firma. Debes firmarlo primero con Python.', 'err');
      return;
    }
    
    log('✅ Firma detectada en el JSON', 'info');
    
    // Crear instancia de Arweave
    const arweave = Arweave.init({
      host: 'arweave.net',
      port: 443,
      protocol: 'https'
    });
    
    // Reconstruir transacción desde JSON firmado
    const transaction = await arweave.createTransaction(signedTx);
    
    // Copiar todos los campos necesarios
    transaction.setSignature({
      id: signedTx.id,
      owner: signedTx.owner,
      tags: signedTx.tags,
      target: signedTx.target,
      quantity: signedTx.quantity,
      data: signedTx.data,
      data_size: signedTx.data_size,
      data_root: signedTx.data_root,
      reward: signedTx.reward,
      signature: signedTx.signature
    });
    
    // Enviar transacción
    log('Enviando transacción a Arweave...', 'event');
    const response = await arweave.transactions.post(transaction);
    
    log('Respuesta del servidor: ' + response.status + ' ' + response.statusText, 'info');
    
    if (response.status === 200 || response.status === 208) {
      log('✅ Transacción enviada exitosamente!', 'info');
      log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
      log('TX ID: ' + signedTx.id, 'event');
      log('Ver en ViewBlock: https://viewblock.io/arweave/tx/' + signedTx.id, 'event');
      log('Ver en ArScan: https://arscan.io/tx/' + signedTx.id, 'event');
      log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
    } else {
      log('❌ Error enviando transacción. Status: ' + response.status, 'err');
      if (response.data) {
        log('Detalles: ' + JSON.stringify(response.data), 'err');
      }
    }
    
  } catch (e) {
    log('Error procesando JSON firmado => ' + e.message, 'err');
    console.error(e);
  }
  
  // Reset input
  e.target.value = '';
});

// Opcional: escucha mensajes cruzados del wallet (por si manda eventos)
window.addEventListener("message", ev => {
  if (typeof ev.data === "object" && ev.data.type && ev.data.type.includes('arweave')) {
    const data = JSON.stringify(ev.data, null, 2);
    log("Mensaje postMessage capturado => " + data, "event");
  }
});
</script>
</body>
</html>
