<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login con firma Arweave</title>
</head>
<body>
  <h2>Autenticaci√≥n segura</h2>
  
  <button id="generar">Generar archivo para firmar</button>
  <input type="file" id="upload" accept=".json" />
  
  <script type="module">
    import Arweave from "https://esm.sh/arweave";

    const arweave = Arweave.init();
    let sessionNonce = null;

    document.getElementById("generar").onclick = () => {
      sessionNonce = crypto.randomUUID();
      const timestamp = Date.now();

      const data = {
        action: "login-request",
        nonce: sessionNonce,
        timestamp,
        tags: [
          { name: "App-Name", value: "MiDApp" },
          { name: "Login-Type", value: "Signature" },
          { name: "Content-Type", value: "application/json" },
        ],
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.click();
      console.log("‚úÖ firmar.json generado");
    };

    document.getElementById("upload").onchange = async (e) => {
      const file = e.target.files[0];
      const text = await file.text();
      const txData = JSON.parse(text);

      console.log("üìÇ Archivo cargado:", txData);

      if (txData.data) {
        console.log("üîç Validando nonce...");
        const parsedData = JSON.parse(txData.data);
        if (parsedData.nonce === sessionNonce) {
          console.log("‚úÖ Nonce v√°lido. Usuario autenticado.");
        } else {
          console.error("‚ùå Nonce inv√°lido. Firma no coincide.");
        }
      } else {
        console.error("‚ùå Archivo inv√°lido o no firmado correctamente.");
      }
    };
  </script>
</body>
</html>

