<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wander Manual Sign Debug</title>
</head>
<body>
  <h2>ğŸ§© Wander Manual Sign Debug</h2>
  <button id="connectBtn">Conectar con Wander</button>
  <button id="generateBtn" disabled>Generar firmar.json</button>
  <input type="file" id="fileInput" accept=".json" />
  <pre id="output"></pre>

  <script>
    const out = (msg, data) => {
      const pre = document.getElementById("output");
      pre.textContent += "\n" + msg + (data ? "\n" + JSON.stringify(data, null, 2) : "");
    };

    const connectBtn = document.getElementById("connectBtn");
    const generateBtn = document.getElementById("generateBtn");
    const fileInput = document.getElementById("fileInput");

    let address = null;

    connectBtn.onclick = async () => {
      if (!window.arweaveWallet) {
        alert("Instala la extensiÃ³n Wander primero.");
        return;
      }
      try {
        await window.arweaveWallet.connect(["ACCESS_ADDRESS"]);
        address = await window.arweaveWallet.getActiveAddress();
        out("âœ… Conectado con Wander", { address });
        generateBtn.disabled = false;
      } catch (e) {
        out("âŒ Error al conectar", { error: e.message });
      }
    };

    // Genera JSON sin firmar
    generateBtn.onclick = async () => {
      const tx = {
        format: 2,
        owner: "",
        target: "",
        quantity: "0",
        data: btoa("login-request-" + Date.now()),
        reward: "0",
        last_tx: "",
        tags: [
          { name: "App-Name", value: "ManualLogin" },
          { name: "Content-Type", value: "text/plain" },
        ],
      };
      const blob = new Blob([JSON.stringify(tx, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.click();
      out("ğŸ“„ Archivo generado: firmar.json");
    };

    // Cargar archivo firmado
    fileInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const tx = JSON.parse(text);
        out("ğŸ“‚ Archivo firmado cargado", tx);
        if (!tx.signature) {
          out("âŒ No contiene firma");
          return;
        }

        // Verificar firma (solo si arweave.js estÃ¡ disponible)
        out("âš™ï¸ Verificando firma...");
        const valid = await verifySignature(tx);
        if (valid) {
          out("âœ… Firma vÃ¡lida. DirecciÃ³n verificada: " + address);
        } else {
          out("âŒ Firma invÃ¡lida");
        }
      } catch (err) {
        out("âŒ Error al leer JSON", { error: err.message });
      }
    };

    async function verifySignature(tx) {
      try {
        // cargar arweave-js dinamicamente
        const script = document.createElement("script");
        script.src = "https://unpkg.com/arweave@1.14.4/bundles/web.bundle.min.js";
        document.body.appendChild(script);
        await new Promise(r => script.onload = r);

        const arweave = window.Arweave.init();
        return await arweave.transactions.verify(tx);
      } catch (e) {
        out("âš ï¸ No se pudo verificar la firma", { error: e.message });
        return false;
      }
    }
  </script>
</body>
</html>
