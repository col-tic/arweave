<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login con firma Arweave</title>
</head>
<body>
  <h2>Autenticaci√≥n segura (firma fuera de l√≠nea)</h2>

  <button id="generar">üßæ Generar archivo para firmar</button>
  <br><br>
  <input type="file" id="upload" accept=".json" />

  <script type="module">
    // Importar Arweave s√≥lo si luego verificas firmas
    import Arweave from "https://esm.sh/arweave";

    const arweave = Arweave.init();
    let sessionNonce = null;

    // --- Generar archivo firmar.json ---
    document.getElementById("generar").onclick = () => {
      sessionNonce = crypto.randomUUID();
      const timestamp = Date.now();

      const data = {
        action: "login-request",
        nonce: sessionNonce,
        timestamp,
        tags: [
          { name: "App-Name", value: "MiDApp" },
          { name: "Login-Type", value: "Signature" },
          { name: "Content-Type", value: "application/json" },
        ],
      };

      // Crear blob con el JSON
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });

      // Crear enlace de descarga
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "firmar.json";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click(); // Forzar descarga
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);

      console.log("‚úÖ firmar.json generado y descargado");
      console.log(data);
    };

    // --- Cargar archivo firmado ---
    document.getElementById("upload").onchange = async (e) => {
      const file = e.target.files[0];
      const text = await file.text();
      const txData = JSON.parse(text);

      console.log("üìÇ Archivo cargado:", txData);

      // Validar si tiene campo 'data' con JSON original
      if (txData.data) {
        const original = JSON.parse(txData.data);
        if (original.nonce === sessionNonce) {
          console.log("‚úÖ Nonce v√°lido. Usuario autenticado.");
        } else {
          console.error("‚ùå Nonce inv√°lido.");
        }
      } else {
        console.error("‚ùå Archivo inv√°lido o no firmado.");
      }
    };
  </script>
</body>
</html>

