<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Verificar firmado Arweave</title>
</head>
<body>
  <h3>Verificar firmado.json (ArDrive / Python)</h3>

  <input id="file" type="file" accept=".json" />
  <button id="check" disabled>Verificar</button>

  <pre id="out" style="background:#000;color:#0f0;padding:10px;height:300px;overflow:auto;"></pre>

  <script>
    // Utils
    const $ = id => document.getElementById(id);
    const outEl = $("out");
    const log = (...args) => { console.log(...args); outEl.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ') + "\\n"; outEl.scrollTop = outEl.scrollHeight; };

    let jsonText = null;

    // Cargar arweave-js dinÃ¡micamente
    async function ensureArweave() {
      if (window.Arweave) return window.Arweave;
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://unpkg.com/arweave@1.14.4/bundles/web.bundle.min.js";
        s.onload = () => { resolve(window.Arweave); };
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    // Leer archivo
    $("file").addEventListener("change", async (ev) => {
      outEl.textContent = "";
      const f = ev.target.files[0];
      if (!f) return;
      const text = await f.text();
      try {
        const json = JSON.parse(text);
        jsonText = json;
        log("ğŸ“‚ Archivo cargado:", f.name);
        log("ğŸ‘€ Keys presentes:", Object.keys(json));
        $("check").disabled = false;
      } catch (e) {
        log("âŒ JSON invÃ¡lido:", e.message);
        $("check").disabled = true;
      }
    });

    // Verificar
    $("check").addEventListener("click", async () => {
      if (!jsonText) return log("No hay JSON cargado.");
      try {
        const Arweave = await ensureArweave();
        const arweave = Arweave.init(); // default conecta a arweave.net

        // Reconstruir la instancia Transaction a partir del JSON
        const tx = new arweave.transactions.Transaction(jsonText);

        log("ğŸ” Verificando transacciÃ³n...");
        const ok = await arweave.transactions.verify(tx);
        log("âœ… verify() result:", ok);

        // Obtener address desde owner
        try {
          const owner = tx.owner;
          const address = await arweave.wallets.ownerToAddress(owner);
          log("ğŸ‘¤ owner:", owner);
          log("ğŸ· address:", address);
        } catch (e) {
          log("âš ï¸ No se pudo derivar address:", e.message);
        }

        // Mostrar algunos campos relevantes
        log("tx.id:", tx.id);
        log("tx.signature:", Boolean(tx.signature));
        log("tx.tags:", tx.tags || []);

      } catch (err) {
        log("âŒ Error verificando:", err && err.message ? err.message : err);
      }
    });
  </script>
</body>
</html>
